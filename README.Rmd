---
title: "Survey123_to_HEPDATA vignette"
author: "Scott Jennings"
date: "8/11/2021"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r }
library(DiagrammeR)

```
# Survey123_to_HEPDATA
Process and screen ACR Heron and Egret Monitoring Project data that was entered in Survey123; end goal is screened data for input into HEPDATA. Processing the data from Survey123 to HEPDATA is comprised of 6 steps:
```{r }
DiagrammeR::grViz("digraph {
  graph [layout = dot, rankdir = TB, nodesep=1, ranksep=2]
  
  
  node [shape = folder, style = filled, fillcolor = Beige, fontsize = 100] 
  cir1 [label = 'Object 1. Survey123 data downloaded from webpage\n*saved as data/downloaded/HEP_[year]_[version number]']
  cir2 [label = 'Object 2. list of dataframes, each containing like data\n*saved as data/wrangled/wrangled_s123_[year]']
  cir3 [label = 'Object 3. Season Summary Sheets as .docx files\n*saved to season_summary_forms/[year]/[colony code]_[year]_[species code]']
  cir4 [label = 'Object 4. Season Summary Sheets edited with screening changes as .docx files\n*change file name to season_summary_forms/[year]/[colony code]_[year]_[species code]_screened1 or screened2,\nwith final number reflecting number of times sheet screened']
  cir5 [label = 'Object 5. list of dataframes, each containing like data\n*saved as data/screened/screened_s123_[year]']
  cir6 [label = 'Object 6. list of dataframes with unique records of objects 2 and 4\n*save output as data/track_changes/track_changes_s123_[year]']
  cir7 [label = 'Object 7. Screened data in HEPDATA format\n*save as data/as_HEPDATA/as_HEPDATA_[year]']
  
  node [shape = rectangle, style = filled, fillcolor = DeepSkyBlue1, fontsize = 100]        
  rec1 [label = 'Step 1. wrangle Survey123 data\n*fix field names\n*fix date fields\n*separate like data types']
  rec2 [label = 'Step 2. output Season Summary Sheet\n*separate sheet for each colony X species combination with at least 1 nest']
  rec3 [label =  'Step 3. Manually screen each Season Summary Sheet']
  rec4 [label = 'Step 4. Extract screened data from Season Summary Sheets\n*reshape to list of dataframes with same structure as output of step 1']
  rec5 [label = 'Step 5. Generate log of screening changes\n*join output of step 1 and step 4\n*identify records that exist in step 4 output but not step 1 output as those that were changed during screening']
  rec6 [label = 'Step 6. Convert screened data to HEPDATA format\n*convert back to a single, wide dataframe\n*change names to match HEPDATA']
  
  # edge definitions with the node IDs
  edge [penwidth = 30, arrowtype = none]
  cir1 -> rec1 -> cir2 -> rec2 -> cir3 -> rec3 -> cir4 -> rec4 -> cir5 -> rec5 -> cir6 -> rec6 -> cir7
  }",
  height = 1000,
  width = 1000)
  
```

Each of these steps involves multiple sub-steps, and each major step has its own code file where the functions and processes for each sub-step are defined. Users generally will not need to access or open the major step code files. Rather, all the functions can be loaded with source(), and the file Survey123_to_HEPDATA_workflow.R should serve as a vignette with examples and instructions to call the functions for the entire workflow.

Each step involve writing files to disk. Thus it is important that this workflow be conducted in a location with the following folder structure:  
  
* Survey123_to_HEPDATA
    + code
    + data
        - downloaded
        - screened
        - track_changes
        - wrangled
    + season_summary_forms
        - 2020
        - 2021
        - ->more years as needed
        - sheet_creation_logs
    + Survey123_to_HEPDATA.Rproj




Some notes on the logic and motivation for this workflow.
The screening and data management process described here was designed to mimic the prior screening process as much as possible. The important aspects of the prior process that we wanted to retain  were 1: to have the data viewable in a Season Summary Sheet-like format; 2: have those data editable; and 3: have those edits carry forward and be trackable. This motivation created some constraints, and these constraints in part led to the somewhat complicated workflow described here.

However, it should be noted that this data structure is consistent throughout most of the steps in this new process. Thus, if at a later date it is decided that the manual screening is not needed, then it will be fairly straightforward to eliminate steps 2, 3, and 4. Those steps could perhaps be replaced by a single automated screening step. Or, the output from step 1 can be used as the input for step 6 if for some reason it is decided that no data screening are necessary

wrangled_s123 columns or info not making it through to screened_s123

observers$role
predators date of predator observation
