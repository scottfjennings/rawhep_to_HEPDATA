---
title: ""
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE,
                      ft.align = "left")


```


```{r}

library(tidyverse)
library(lubridate)
library(RColorBrewer)
library(rhandsontable)
library(flextable)
library(officer)
library(here)
library(knitr)
library(xlsx)
library(birdnames)

source("https://raw.githubusercontent.com/scottfjennings/rawhep_to_HEPDATA/main/code/append_species_not_nesting.R")
source("https://raw.githubusercontent.com/scottfjennings/rawhep_to_HEPDATA/main/code/rawhep_to_HEPDATA_utility_functions.R")
options(scipen = 999)
lead.col.width = c(1, 0.6, 0.75)
date.col.width = 0.6

# consistent colors for plotting
species.colors <- c("Great Egret" = "gray90", "Great Blue Heron" = "blue", "Snowy Egret" ="lightgoldenrod2", "Black-crowned Night-Heron" = "green3", "Cattle Egret" = "red2", "Double-crested Cormorant" = "purple1")


```

```{r}
# input the year you are working with and read in the wrangled Survey123 data
zyear = 2021
wrangled_s123 <- readRDS(here(paste("data/wrangled/wrangled_s123", zyear, sep = "_")))

# input the colony code and species you want to generate a season summary sheet for

zcode = 29.0

observers <- read.csv(here("data/HEP_tracking_copy/observers.csv")) %>% 
  filter(SITE.CODE == zcode, year == zyear) %>% 
  mutate(observer.name = paste(FIRST.NAME, LAST.NAME))



site_name = readRDS(here("data/HEP_site_names_nums_utm")) %>% 
  filter(code == zcode) %>% 
  select(site.name)



```

Summary of nest monitoring at `r site_name$site.name` in `r zyear`.



<br>
```{r}
# make text listing volunteers and summary of effort 

seas_summary_observers <- wrangled_s123$observers %>% 
  filter(code == zcode) %>% 
  mutate(observers = gsub("\\*", "", observers))


out_length <- length(str_split(seas_summary_observers$observers,"\\;")[[1]])

obs_list <- seas_summary_observers  %>% 
  select(observers) %>% 
  separate(observers, sep = ";", into = paste("obs", seq(1:out_length))) %>% 
  pivot_longer(cols = contains("obs"), values_to = "observer.name") %>% 
  mutate(observer.name = trimws(observer.name)) %>% 
  full_join(., observers %>% select(observer.name, Coordinator.))

observers_text <- paste(c(obs_list$observer.name[-length(obs_list$observer.name)], 'and', obs_list$observer.name[length(obs_list$observer.name)]), collapse = ", ")
  
obs_text <- gsub("and,", "and", observers_text)

if(nrow(obs_list) > 1 & any(obs_list$Coordinator. == "yes", na.rm = TRUE)) {
  observers_text <- paste(obs_text, "monitored the", distinct(seas_summary_observers, colony), "colony, and", filter(obs_list, Coordinator. == "yes")$observer.name, "was the site coordinator. These observers")
}


if(nrow(obs_list) > 1 & any(obs_list$Coordinator. != "yes", na.rm = TRUE)) {
  observers_text <- paste(obs_text, "monitored the", distinct(seas_summary_observers, colony), "colony. These observers")
}


if(nrow(obs_list) == 1) {
  observers_text <- paste(obs_list$observer.name, "monitored the", distinct(seas_summary_observers, colony), "colony, and")
}


dates <- wrangled_s123$dates %>% 
  filter(code == zcode)

total.surveys = nrow(dates)
  
top_table <- data.frame(observers = seas_summary_observers$observers,
                        #total.days = nrow(distinct(dates, date)),
                        total.surveys = nrow(dates),
                        total.hours = round(as.numeric(sum(dates$end - dates$start)/60),2)) %>% 
  mutate(observers = gsub("\\*", "", observers))

  

```

In `r zyear`, `r observers_text` made `r total.surveys` site visits to the colony for a total of `r seas_summary_observers$total.hours` hours of observation.  

Below is a summary of the data they collected and what we can conclude from those data.

```{r}
#flextable(top_table) %>% 
#  set_header_labels(observers = "Observers", total.surveys = "Number of site visits", total.hours = "Total observation hours") %>% 
#  autofit() %>% 
#  fit_to_width(max_width = 8.5)

```


<br>

```{r}


# total nests  
total.nests <- wrangled_s123$nests %>% 
  filter(code == zcode) %>% 
  #select(species, date, multiple.survey.num, total.nests) %>%   
  arrange(date) %>%
  mutate(date = as.character(date),
         date = gsub(paste(zyear, "-", sep = ""), "", date),
         date = ifelse(multiple.survey.num > 1, paste(date, multiple.survey.num, sep = "."), date)) %>% 
  select(-multiple.survey.num) 

just.nesters <- total.nests %>% 
  group_by(species) %>% 
  mutate(tot.nests = sum(total.nests)) %>%
  ungroup() %>% 
  filter(tot.nests > 0) %>% 
  select(-tot.nests)

nests.wider <- just.nesters %>% 
  select(-code, -complete.count, -peak.active, -obs.initials) %>% 
  pivot_wider(values_from = total.nests, names_from = date)

curr_year_peakactvnsts <- wrangled_s123$nests %>% 
  filter(code == zcode, peak.active == TRUE) %>% 
  select(species, code, date, total.nests) %>% 
  filter(total.nests == max(total.nests)) %>% 
  rename(peakactvnsts = total.nests) %>% 
  mutate(year = zyear)


peakactive_text <- curr_year_peakactvnsts %>% 
  mutate(md.text = paste(day(date), month(date, label = TRUE)),
         peakactive.text = paste("There were a total of ", peakactvnsts, " ", translate_bird_names(species, "alpha.code", "common.name"), " nests, observed on", md.text, ".", sep = "")) %>% 
  summarise(peakactive.text = paste(peakactive.text, collapse = " "))
    
```

<br>
**Colony Size Estimate**  

Total number of active nests observed on each visit date:

```{r}
nest_totals <- nests.wider %>% 
  mutate(species = translate_bird_names(species, "alpha.code", "common.name")) %>% 
  rename(Species = species) %>% 
  date_table_splitter(num_dates_per_split = 9)
```

```{r}
nest_totals$sub_table1 
```

```{r}
if(!is.null(nest_totals$sub_table2)) {
nest_totals$sub_table2 
}
```

```{r}
if(!is.null(nest_totals$sub_table3)) {
nest_totals$sub_table3
}
```

```{r}
if(!is.null(nest_totals$sub_table4)) {
nest_totals$sub_table4 
}
```

```{r}
if(!is.null(nest_totals$sub_table5)) {
nest_totals$sub_table5 
}
```
<br>  

We use these data to determine the maximum number of active nests in the colony, to evaluate changes in the overall breeding population. `r peakactive_text`  

How does `r zyear` compare with previous years? Below is a plot of this year's peak abundance along with the historic nest abundance.    

```{r fig.width=8}
historic_nest_abund <- readRDS(here("data/hep_annual_nest_abundance")) %>% 
  filter(code == zcode, species %in% just.nesters$species) %>% 
  ungroup() %>% 
  select(year, species, peakactvnsts) %>% 
  bind_rows(curr_year_peakactvnsts %>% select(year, species, peakactvnsts)) %>% 
  mutate(species = translate_bird_names(species, "alpha.code", "common.name"))

historic_nest_abund %>%  
  ggplot() + 
  #geom_point(aes(x = year, y = peakactvnsts)) + 
  #stat_smooth(aes(x = year, y = peakactvnsts), color = "black", se = FALSE, span = 1) +
  #geom_point(data = curr_year_peakactvnsts, aes(x = year, y = peakactvnsts), color = "red") +
  theme_bw()  +
  geom_col(aes(x = year, y = peakactvnsts, fill = species), color = "black") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  +
  scale_x_continuous(labels = seq(min(historic_nest_abund$year), zyear), breaks = seq(min(historic_nest_abund$year), zyear)) +
  scale_fill_manual(values = species.colors[translate_bird_names(distinct(just.nesters, species), "alpha.code", "common.name")]) +
  labs(y = "Total number of nests",
       x = "",
       title = "Peak number of active nests",
       fill = "")


```


<br>
**Seasonal Timing**  

Number of nests at each stage on each visit date (clearly observed nests only):
```{r}

if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
nest_stages_df <- wrangled_s123$stages %>% 
  filter(code == zcode, species %in% distinct(just.nesters, species)) %>% 
  mutate(stage = paste("stage", stage, sep = ".")) %>% 
  arrange(date) %>% 
  mutate(date = as.character(date),
         date = gsub(paste(zyear, "-", sep = ""), "", date),
         date = ifelse(multiple.survey.num > 1, paste(date, multiple.survey.num, sep = "."), date),
         num.nests = as.character(num.nests)) %>% 
  select(-multiple.survey.num) %>% 
  pivot_wider(id_cols = c(species, stage), names_from = date, values_from = num.nests) %>% 
  mutate(stage = gsub("stage.", "", stage)) %>% 
  mutate(species = ifelse(stage == 1, translate_bird_names(species, "alpha.code", "common.name"), "")) %>% 
  rename(Species = species)

}

if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
zyear_phenology <- wrangled_s123$stages %>% 
  filter(code == zcode, species %in% distinct(just.nesters, species), which.rop == "rop.5")  %>% 
  mutate(stage = paste("junstage", stage, sep = "")) %>% 
  pivot_wider(id_cols = species, names_from = stage, values_from = num.nests) %>% 
  mutate(across(contains("junstage"), ~replace_na(., 0)),
         jun.prop.unguarded = (junstage4 + junstage5)/(junstage1 + junstage2 + junstage3 + junstage4 + junstage5),
         jun.prop.unguarded.se = sqrt((jun.prop.unguarded *(1-jun.prop.unguarded)) / (junstage1 + junstage2 + junstage3 + junstage4 + junstage5)))

phenology_text <- zyear_phenology %>% 
  mutate(species = translate_bird_names(species, "alpha.code", "common.name"),
         phenology.text = paste("For ", species, ", the proportion of nests unguarded on the early June Observation period was ", round(jun.prop.unguarded, 2), " (SE = ", round(jun.prop.unguarded.se, 2), ").", sep = "")) %>% 
  summarise(phenology.text = paste(phenology.text, collapse = " "))


}

```

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
nest_stages <- nest_stages_df %>%
  date_table_splitter(num_dates_per_split = 9)
}
```
<br>



```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
nest_stages$sub_table1 %>% 
#  add_header_row(values = c("", "Number of nests each date:"), colwidths = c(1, length(nest_stages$sub_table1) - 1)) %>% 
    set_header_labels(variable = "Nest stage")
}
```

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
  if(!is.null(nest_stages$sub_table2)) {
nest_stages$sub_table2 %>% 
    set_header_labels(variable = "Nest stage")
  }
}
```

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
  if(!is.null(nest_stages$sub_table3)) {
nest_stages$sub_table3 %>% 
    set_header_labels(variable = "Nest stage")
  }
  }
```

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
  if(!is.null(nest_stages$sub_table4)) {
nest_stages$sub_table4 %>% 
    set_header_labels(variable = "Nest stage")
  }
}
```

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
  if(!is.null(nest_stages$sub_table5)) {
nest_stages$sub_table5 %>% 
    set_header_labels(variable = "Nest stage")
  }
}
```
<br>

The proportion of nests that have reached the unguarded stage (stages 4 and 5) by the June Regional Nest Observation Period is a useful metric for us to gauge the timing of nesting each season. A larger than average proportion of unguarded nests suggests that the birds began nesting earlier that year than normal. `r phenology_text`  

How does this compare to previous years?  


```{r fig.width=8}
historic_phenology <- readRDS(here("data/hep_annual_phenology")) %>% 
  filter(code == zcode, species %in% just.nesters$species) %>% 
  ungroup() %>% 
  bind_rows(zyear_phenology %>%  mutate(year = zyear)) %>% 
  mutate(species = translate_bird_names(species, "alpha.code", "common.name"))

historic_phenology %>%  
  ggplot() + 
  theme_bw() +
  geom_errorbar(aes(x = year, ymax = jun.prop.unguarded + jun.prop.unguarded.se, ymin = jun.prop.unguarded - jun.prop.unguarded.se))  +
  geom_col(aes(x = year, y = jun.prop.unguarded, fill = species), color = "black") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))  +
  scale_x_continuous(labels = seq(min(historic_phenology$year), zyear), breaks = seq(min(historic_phenology$year), zyear)) +
  scale_fill_manual(values = species.colors[translate_bird_names(distinct(just.nesters, species), "alpha.code", "common.name")]) +
  labs(y = "Proportion of nests unguarded in June",
       x = "",
       title = "Intraseasonal timing",
       fill = "")


```

<br>

```{r}
# stage 4 brood sizes
first_stage5_date <- wrangled_s123$stages %>% 
  filter(code == zcode, species %in% distinct(just.nesters, species)) %>%
  filter(stage == 5, num.nests > 0) %>% 
  filter(date == min(date)) %>% 
  select(code, species, date)

if(nrow(first_stage5_date) == 0) {
  first_stage5_date = data.frame(code = zcode,
                                 species = zspp,
                                 date = NA)
}






if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
 brood_sizes <- wrangled_s123$brood.sizes %>% 
  filter(code == zcode, species %in% distinct(just.nesters, species)) %>% 
  group_by(date, species) %>% 
  mutate(max.num.nest = max(num.nests)) %>% 
  ungroup() %>% 
  filter(max.num.nest > 0) %>% 
  select(-max.num.nest) 
if(nrow(brood_sizes) > 0) {
brood_sizes_wide <- brood_sizes %>% 
  mutate(brd = paste("brd.", brd, sep = ""),
         year = zyear,
         stage5.nests = replace_na(stage5.nests, FALSE)) %>% 
  select(-multiple.survey.num) %>% 
  pivot_wider(id_cols = c(species, date, stage5.nests), values_from = num.nests, names_from = brd) %>% 
  mutate(date = ymd(date)) %>% 
  arrange(species, date) %>% 
  group_by(species) %>% 
  mutate(species = ifelse(date == min(date), translate_bird_names(species, "alpha.code", "common.name"), "")) %>% 
  select(species, date, everything())
} else {
  brood_sizes_wide <- data.frame(species = NA,
                                 date = NA,
                                 stage5.nests = NA,
                                 brd.1 = NA,
                                 brd.2 = NA,
                                 brd.3 = NA,
                                 brd.4 = NA,
                                 brd.5 = NA)
}
}

if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
zyear_productivity <- wrangled_s123$brood.sizes %>% 
  filter(code == zcode, species %in% distinct(just.nesters, species), brd.size.date == TRUE) %>%
  mutate(brd = paste("brd", brd, sep = ""),
         year = zyear) %>% 
  pivot_wider(id_cols = c(code, year, species), names_from = brd, values_from = num.nests) %>% 
  mutate(across(contains("brd"), ~replace_na(., 0)),
         total.brd.nests = brd1 + brd2 + brd3 + brd4 + brd5) %>% 
  group_by(year, species, code) %>% 
  mutate(mean.chx.per.nest = mean(c(rep(1, brd1), rep(2, brd2), rep(3, brd3), rep(4, brd4), rep(5, brd5))),
         sd.chx.per.nest = sd(c(rep(1, brd1), rep(2, brd2), rep(3, brd3), rep(4, brd4), rep(5, brd5)))) %>% 
  ungroup() %>% 
  mutate(st.err.chx.per.nest = sqrt(sd.chx.per.nest/total.brd.nests))

brood_sizes_text <- zyear_productivity %>% 
   mutate(species = translate_bird_names(species, "alpha.code", "common.name"),
          brood.sizes.text = paste("For ", species, ", the average number of chicks per fledged nest was ", round(mean.chx.per.nest, 2), " (SE = ", round(st.err.chx.per.nest, 2), ").", sep = ""))  %>% 
  summarise(brood.sizes.text = paste(brood.sizes.text, collapse = " "))
}

```
<br>
**Productivity**  


Number of broods of each size class (1, 2, 3, 4, or five chicks) observed on each visit date (Stage 4 nests only).

```{r}
if(any(just.nesters$species %in% c("GREG", "GBHE"))) {
flextable(brood_sizes_wide) %>% 
    set_header_labels(species = "Species",
                      date = "Date",
                      stage5.nests = "Stage 5 chicks also present",
                      brd.1 = "1 chick",
                      brd.2 = "2 chicks",
                      brd.3 = "3 chicks",
                      brd.4 = "4 chicks",
                      brd.5 = "5 chicks") %>% 
  border_remove() %>% 
  add_header_row(values = c("", "Number of stage 4 nests with:"), colwidths = c(3, 5)) %>% 
  align(j = c(1:3), align = "left", part = "all") %>% 
  align(j = c(4:8), align = "center", part = "all") %>% 
  autofit() %>% 
  width(j = 3, width = 1.25) %>% 
  width(j = 4:8, width = 0.75) %>% 
  border(border.top = fp_border(), part = "header", i = 1) %>% 
  border(border.bottom = fp_border(), part = "header", i = 1, j = 4:8) %>% 
  border(border.bottom = fp_border(), part = "header", i = 2) %>% 
  border(i = nrow(brood_sizes_wide), border.bottom = fp_border(), part = "body")
}
```


We use data on the number of stage 4 chicks to estimate how many chicks fledged from successful nests. Because stage 5 chicks may move into neighboring nests, we calculate the number of chicks per nest only on days when there are no stage 5 chicks observed in the colony. `r brood_sizes_text`  

How does this compare to previous years? 

```{r fig.width=8}
historic_productivity <- readRDS(here("data/hep_annual_new_productivity")) %>% 
  filter(code == zcode, species %in% just.nesters$species) %>% 
  ungroup() %>% 
  bind_rows(zyear_productivity)

historic_productivity %>%  
  ggplot() + 
  theme_bw() +
  geom_errorbar(aes(x = year, ymax = mean.chx.per.nest + st.err.chx.per.nest, ymin = mean.chx.per.nest - st.err.chx.per.nest))  +
  geom_col(aes(x = year, y = mean.chx.per.nest, fill = species), color = "black") +
  #geom_col(data = curr_year_peakactvnsts, aes(x = factor(year), y = peakactvnsts), color = "red", fill = "red") + 
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  scale_x_continuous(labels = seq(min(historic_productivity$year), zyear), breaks = seq(min(historic_productivity$year), zyear)) +
  scale_fill_manual(values = species.colors[translate_bird_names(distinct(just.nesters, species), "alpha.code", "common.name")]) +
  labs(y = "Average number of chicks\nfledged per successful nest",
       x = "",
       title = "Productivity")


```



The observers also collected information on disturbance to the colony, including the presense and nesting status of any potential nest predators.

```{r}
# disturbance
disturbance <- wrangled_s123$disturbance %>% 
  filter(code == zcode) %>% 
  mutate(type = disturbance_code_to_text(type),
         result = disturbance_response_to_text(result)) %>% 
  distinct(date, type, description, result) %>% 
  select(date, type, description, result) %>% 
  select(Daye = date, Type = type, Description = description, Result = result)

```
<br>
Disturbance to colony
```{r}
flextable(disturbance) %>% 
  autofit() %>% 
  fit_to_width(max_width = 7.5) %>% 
  width(j = 3, width = 4)
```


```{r}
# predators
predators <- wrangled_s123$predators %>% 
  filter(code == zcode) %>% 
  distinct(code, predator.species, nesting, present) %>% 
  mutate(across(c(nesting, present), ~ifelse(. == 1, "Yes", "No")),
         across(c(nesting, present), ~ifelse(is.na(.), "No", .)),
         predator.species = translate_bird_names(predator.species, "alpha.code", "common.name")) %>% 
  select(-code)

```
<br> 
Nest predatory species
```{r}
flextable(predators) %>% 
  set_header_labels(predator.species = "Species",
                    present = "Present",
                    nesting = "Predator nest observed") %>% 
  autofit()

```

<br>




